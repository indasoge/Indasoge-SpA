<?xml version="1.0" encoding="utf-8" ?>
<odoo>

    <!-- QWeb Reports -->
    <record id="account_invoices" model="ir.actions.report">
        <field name="name">Factura Cedible</field>
        <field name="model">account.move</field>
        <field name="report_type">qweb-pdf</field>
        <field name="report_name">account_move_cedible.report_invoice_with_payments_cedible</field>
        <field name="report_file">account_move_cedible.report_invoice_with_payments_cedible</field>
        <field name="print_report_name">(object._get_report_base_filename())</field>
        <field name="attachment">(object.state == 'posted') and ((object.name or 'INV').replace('/','_')+'.pdf')</field>
        <field name="binding_model_id" ref="account.model_account_move"/>
        <field name="binding_type">report</field>
        <field name="groups_id" eval="[(4, ref('account.group_account_invoice')),
 (4, ref('account.group_account_readonly'))]"/>
    </record>


    <template id="report_invoice_document" inherit_id="account.report_invoice_document" primary="True">
        <t t-set="o" position="after">
            <t t-set="custom_header" t-value="'l10n_cl.custom_header'"/>
        </t>

        <!-- remove default partner address -->
        <t t-set="address" position="replace"/>
        
        <xpath expr="//div[@name='address_not_same_as_shipping']" position="replace">
            <div name="address_not_same_as_shipping"/>
        </xpath>
        <xpath expr="//div[@name='address_same_as_shipping']" position="replace">
            <div name="address_same_as_shipping"/>
        </xpath>
        <xpath expr="//div[@name='no_shipping']" position="replace">
            <div name="no_shipping"/>
        </xpath>

        <xpath expr="//h2" position="replace"/>

        <t t-set="current_subtotal" t-value="current_subtotal + line.price_subtotal" position="before">
            <t t-set="l10n_cl_values" t-value="line._l10n_cl_prices_and_taxes()"/>
        </t>

        <xpath expr="//span[@t-field='line.price_unit']" position="attributes">
            <attribute name="t-field"/>
            <attribute name="t-esc">line.price_unit</attribute>
            <attribute name="t-options">{"widget": "monetary", "display_currency": o.currency_id}</attribute>
        </xpath>

        <xpath expr="//span[@id='line_tax_ids']" position="attributes">
            <attribute name="t-esc">', '.join(map(lambda x: (x.description or x.name), line.tax_lines))</attribute>
        </xpath>

        <t t-set="current_subtotal" t-value="current_subtotal + line.price_subtotal" position="attributes">
            <attribute name="t-value">current_subtotal + l10n_cl_values['price_subtotal']</attribute>
        </t>

        <xpath expr="//th[@name='th_subtotal']/span" position="replace">
            <span>Amount</span>
        </xpath>

        <span t-field="line.price_subtotal" position="attributes">
            <attribute name="t-field"/>
            <attribute name="t-esc">l10n_cl_values['price_subtotal']</attribute>
            <attribute name="t-options">{"widget": "monetary", "display_currency": o.currency_id}</attribute>
        </span>

        <t t-set="tax_totals" position="attributes">
            <attribute name="t-value">o._l10n_cl_get_invoice_totals_for_report()</attribute>
        </t>

        <xpath expr="//th[@name='th_taxes']" position="replace"/>
        <xpath expr="//span[@id='line_tax_ids']/.." position="replace"/>

        <!-- <p name="payment_term" position="replace"/> -->

        <!-- Remove payment reference field -->
        <xpath expr="//span[@t-field='o.payment_reference']/../.." position="replace">
            <div/>
        </xpath>


        <!-- replace information section and usage chilean style -->
        <div id="informations" position="replace">
            <t t-call="l10n_cl.informations"/>
        </div>

        <!--  we remove the ml auto and also give more space to avoid multiple lines on tax detail -->
        <xpath expr="//div[@id='total']/div" position="attributes">
            <attribute name="t-attf-class">#{'col-6' if report_type != 'html' else 'col-sm-7 col-md-6'}</attribute>
        </xpath>

        <xpath expr="//div[@id='total']/div" position="before">
            <div t-attf-class="#{'col-6' if report_type != 'html' else 'col-sm-7 col-md-6'}"/>
        </xpath>

        <xpath expr="//div[@id='total']" position="after">
            <div class="row">
                <div name="stamp" class="col-6 text-center">
                    <br/>
                    <br/>
                    <t t-if="o.l10n_cl_sii_barcode">
                        <t t-set="barcode_stamp" t-value="o._pdf417_barcode(o.l10n_cl_sii_barcode)"/>
                        <t t-if="barcode_stamp">
                            <img class="img-fluid" t-attf-src="data:image/*;base64,{{barcode_stamp}}"/>
                            <p t-att-style="'color: %s;' % o.company_id.primary_color" class="text-center small">
                                Timbre Electrónico SII<br/>
                                Resolución Nº: <span t-field="o.company_id.l10n_cl_dte_resolution_number"/>
                                de Fecha: <span t-field="o.company_id.l10n_cl_dte_resolution_date" t-field-options="{&quot;widget&quot;: &quot;date&quot;}"/>
                    <span name="verification_url">Verifique documento en www.sii.cl</span>
                </p>
            </t>
        </t>
    </div>
    <div name="transferable-legend" class="col-12 pull-right">
        <t t-if="o.l10n_latam_document_type_id._is_doc_type_electronic_ticket()">
                        The VAT tax of this boleta is: <span t-esc="o._l10n_cl_get_amounts()['vat_amount']" t-options="{'widget': 'monetary', 'display_currency': o.currency_id}"/>
        </t>
        <br/>
        <br/>
        <div class="border p-1">
            <div class="row">
                <div class="col-2 ">
                        Nombre
                </div>
                <div class="col-10 ">
                        : _______________________________________________________________
                </div>
            </div>
            <div class="row">
                <div class="col-2 ">
                        R.U.T.
                </div>
                <div class="col-4 ">
                        : _____________________
                </div>
                <div class="col-2 ">
                        Fecha
                </div>
                <div class="col-4 ">
                        : _____________________
                </div>
            </div>
            <div class="row">
                <div class="col-2 ">
                        Recinto
                </div>
                <div class="col-4 ">
                        : _____________________
                </div>
                <div class="col-2 ">
                        Firma
                </div>
                <div class="col-4 ">
                        : _____________________
                </div>
            </div>
            <div class="row">
                <div class="col-12 small">
                         EL ACUSE DE RECIBO QUE SE DECLARA EN ESTE ACTO, DE ACUERDO A LO DISPUESTO EN LA LETRA b)
 DEL Art.4°, Y LA LETRA c) DEL Art.5° DE LA LEY 19.983, ACREDITA QUE LA ENTREGA DE MERCADERIAS O
 SERVICIOS(S) PRESTADO(S) HA(N) SIDO RECIBIDO(S).

                </div>
               
            </div>
        </div>

    </div>

</div>
</xpath>
</template>

<template id="report_invoice_with_payments_cedible">
<t t-call="web.html_container">
<t t-foreach="docs" t-as="o">
    <t t-set="lang" t-value="o.partner_id.lang"/>
    <t t-set="print_with_payments" t-value="True"/>
    <t t-call="account_move_cedible.report_invoice_document" t-lang="lang"/>
</t>
</t>
</template>
</odoo> 
